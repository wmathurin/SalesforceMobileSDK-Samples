<!DOCTYPE html>
<html>
<head>
<title>Beacons</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no;" />
<link rel="stylesheet" href="css/styles.css"/>
<link rel="stylesheet" href="css/ratchet.css"/>
<link rel="stylesheet" href="css/ratchet-theme-android.css"/>

<style>
    .big {
        font-size: 24px;
    }
</style>

</head>

<body>

<div id="content"></div>

<!-- Scripts -->

<!-- Local Testing --/>
<script src="js/jquery.min.js"></script>
<script src="js/underscore-min.js"></script>
<script src="js/backbone-min.js"></script>
<script src="js/forcetk.mobilesdk.js"></script>
<script src="js/MockCordova.js"></script>
<script src="js/cordova.force.js"></script>
<script src="js/smartsync.js"></script>
<script src="js/fastclick.js"></script>
<script src="js/stackrouter.js"></script>
<script src="js/auth_local.js"></script>
<script>
    // Dummy data
    var beacons = [];
    for (var i=0; i<10; i++) {
        beacons.push({uuid:'uuid' + i, major: i, minor: 10*i, proximity:i});
    }
</script>
<!-- End Local Testing -->

<!-- Container -->
<script src="js/jquery.min.js"></script>
<script src="js/underscore-min.js"></script>
<script src="js/backbone-min.js"></script>
<script src="cordova.js"></script>
<script src="js/forcetk.mobilesdk.js"></script>
<script src="js/smartsync.js"></script>
<script src="js/fastclick.js"></script>
<script src="js/stackrouter.js"></script>
<script src="js/auth.js"></script>
<!-- End Container -->


<!-- --------------------------------------- Search page template ------------------------------------------------- -->
<script id="search-page" type="text/template">
  <header class="bar bar-nav">
    <a class="btn btn-nav pull-right btn-positive toggleRanging">Start Ranging</a>
    <h1 class="title">Beacons</h1>
  </header>

  <div class="content">
    <ul class="table-view"></ul>
  </div>
</script>

<!-- --------------------------------------- Beacon list item template ---------------------------------------------- -->
<script id="beacon-list-item" type="text/template">
  <pre  class="important"><%= uuid %></pre>
  <pre class="small"><%= major %>.<%= minor%></pre>
  <span class="pull-right btn btn-positive big"><%= proximity %> m</span>
</script>

<script>
// -------------------------------------------------- The Views ---------------------------------------------------- //

app.views.SearchPage = Backbone.View.extend({

    template: _.template($("#search-page").html()),

    events: {
        "click .toggleRanging": "toggleRanging"
    },

    initialize: function() {
        var self = this;
        this.ranging = false;
        this.model = new Backbone.Collection(window.beacons || []);
        this.model.comparator = "proximity";
        this.listView = new app.views.BeaconListView({model: this.model});
        document.addEventListener("didRangeBeaconsInRegion", function(event) {
            self.model.reset(event.detail);
        });
    },

    render: function(eventName) {
        $(this.el).html(this.template());
        this.listView.setElement($("ul", this.el)).render();
        return this;
    },

    toggleRanging: function() {
        this.ranging = !this.ranging;
        if (this.ranging) {
            cordova.require("com.salesforce.plugin.ibeaconmanager").startRanging();
        }
        else {
            cordova.require("com.salesforce.plugin.ibeaconmanager").stopRanging();
        }
        // XXX should pass successCB and errorCB and only toggle the button if action completes successfully
        $(".toggleRanging", this.el).html(this.ranging?"Stop Ranging":"Start Ranging");
        $(".toggleRanging", this.el).removeClass(this.ranging?"btn-positive":"btn-negative").addClass(this.ranging?"btn-negative":"btn-positive");
    }
});

app.views.BeaconListView = Backbone.View.extend({

    listItemViews: [],

    initialize: function() {
        this.model.bind("reset", this.render, this);
    },

    render: function(eventName) {
        _.each(this.listItemViews, function(itemView) { itemView.close(); });
        this.listItemViews = _.map(this.model.models, function(model) { return new app.views.BeaconListItemView({model: model}); });
        $(this.el).append(_.map(this.listItemViews, function(itemView) { return itemView.render().el;} ));
        return this;
    }

});

app.views.BeaconListItemView = Backbone.View.extend({

    tagName: "li",
    template: _.template($("#beacon-list-item").html()),

    render: function(eventName) {
        $(this.el).addClass("table-view-cell").html(this.template(this.model.toJSON()));
        return this;
    },

    close: function() {
        this.remove();
        this.off();
    }
});


// ----------------------------------------------- The Application Router ------------------------------------------ //

app.Router = Backbone.StackRouter.extend({

    routes: {
        "": "list",
        "list": "list",
    },

    initialize: function() {
        Backbone.Router.prototype.initialize.call(this);

        // We keep a single instance of SearchPage
        app.searchPage = new app.views.SearchPage();
    },

    list: function() {
        this.slidePage(app.searchPage);
    }
});
</script>
</body>
</html>
